name: Deploy to Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∫–Ω–æ–ø–∫—É

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          script: |
            # 1. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç—å /opt/VpnBot, —Ç–∞–∫ –∫–∞–∫ –≤ –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ, —á—Ç–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Ç–∞–º
            TARGET_DIR="/opt/VpnBot"
            
            mkdir -p $TARGET_DIR
            cd $TARGET_DIR
            
            # 2. –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞
            if [ ! -d ".git" ]; then
              echo "üöÄ Repository not found. Cloning..."
              # –ö–ª–æ–Ω–∏—Ä—É–µ–º –≤ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (.)
              git clone git@github.com:MRiazIsr/VpnBot.git .
            else
              echo "üì• Pulling latest code..."
              git pull origin main
            fi
            
            # 3. –°–æ–±–∏—Ä–∞–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫
            export PATH=$PATH:/usr/local/go/bin:/usr/bin
            
            echo "üì¶ Updating dependencies (Fixing missing go.sum)..."
            # –í–ê–ñ–ù–û: –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–∫–∞—á–∞–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            go mod tidy
            
            echo "üî® Building Go binary..."
            go build -o app_bin main.go
            
            # 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
            echo "üîÑ Restarting service..."
            systemctl restart vpnbot
            
            # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            systemctl status vpnbot --no-pager