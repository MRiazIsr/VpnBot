name: Deploy to Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∫–Ω–æ–ø–∫—É

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e

            TARGET_DIR="/opt/VpnBot"
            mkdir -p $TARGET_DIR
            cd $TARGET_DIR

            # 1. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            if [ ! -d ".git" ]; then
              echo "üöÄ Cloning repository..."
              git clone git@github.com:MRiazIsr/VpnBot.git .
            else
              echo "üì• Pulling latest code..."
              git fetch origin main
              git reset --hard origin/main
            fi

            # 2. –°–æ–±–∏—Ä–∞–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫
            export PATH=$PATH:/usr/local/go/bin:/usr/bin
            echo "Go version: $(go version)"

            echo "üì¶ Updating dependencies..."
            go mod tidy

            echo "üî® Building..."
            go build -o app_bin .

            # 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
            echo "üîÑ Restarting service..."
            systemctl restart vpnbot
            sleep 2
            systemctl status vpnbot --no-pager